<!DOCTYPE html>
<html>
<head>
  <title>Voice Assistant</title>
</head>
<body>
  <h2>Talk to Claude</h2>
  <button id="start">Start Talking</button>
  <p id="status">Click to start recording...</p>
  <p><b>You:</b> <span id="userText"></span></p>
  <p><b>Claude:</b> <span id="claudeText"></span></p>

  <script>
    const startBtn = document.getElementById("start");
    const userText = document.getElementById("userText");
    const claudeText = document.getElementById("claudeText");
    const status = document.getElementById("status");

    let ws;

    startBtn.onclick = async () => {
      status.innerText = "Recording...";
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      ws = new WebSocket("ws://127.0.0.1:8000/ws");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        userText.innerText = data.user;
        claudeText.innerText = data.claude;
        status.innerText = "Done.";
        speak(data.claude);
      };

      mediaRecorder.start();
      let chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);

      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/wav' });
        blob.arrayBuffer().then(buffer => {
          ws.send(buffer);
          ws.send("end");
        });
      };

      setTimeout(() => {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
      }, 5000); // 5 seconds max recording
    };

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
